(()=>{"use strict";let e=null,r=!1,t=!1;const o=e=>new Promise(r=>setTimeout(r,e));function n(...e){console.log("[background]",...e)}function s(e){chrome.action.setBadgeText({text:e?"REC":""}).catch?.(()=>{})}async function a(){await async function(){try{const e=chrome.runtime.getContexts;if(e){const r=await e({contextTypes:["OFFSCREEN_DOCUMENT"]}).catch(()=>[]);return Array.isArray(r)&&r.length>0}}catch{}try{return!!await(chrome.offscreen.hasDocument?.())}catch{return!1}}()||(n("Creating offscreen documentâ€¦"),await chrome.offscreen.createDocument({url:chrome.runtime.getURL("offscreen.html"),reasons:["BLOBS","AUDIO_PLAYBACK","USER_MEDIA"],justification:"Record tab audio+video in offscreen using MediaRecorder"}));for(let t=0;t<10&&(!e||!r);t++){try{const e=await chrome.runtime.sendMessage({type:"OFFSCREEN_PING"});if(e?.ok){n("Offscreen responded to PING");break}}catch{}await o(100)}if(!e||!r)try{await chrome.runtime.sendMessage({type:"OFFSCREEN_CONNECT"})}catch{}for(let t=0;t<50;t++){if(e&&r)return;await o(100)}throw new Error("Offscreen did not become ready")}function c(r){return new Promise((t,o)=>{if(!e)return o(new Error("Offscreen port not connected"));const n=Math.random().toString(36).slice(2);r.__id=n;const s=r=>{r&&r.__respFor===n&&(e.onMessage.removeListener(s),t(r.payload))};e.onMessage.addListener(s),e.postMessage(r),setTimeout(()=>{try{e.onMessage.removeListener(s)}catch{}o(new Error("Offscreen response timeout"))},15e3)})}chrome.runtime.onConnect.addListener(o=>{"offscreen"===o.name&&(n("Offscreen connected"),e=o,r=!1,o.onMessage.addListener(o=>{if("OFFSCREEN_READY"===o?.type&&(r=!0,n("Offscreen is READY (Port)")),"RECORDING_STATE"===o?.type&&(t=!!o.recording,s(t),chrome.runtime.sendMessage({type:"RECORDING_STATE",recording:t}).catch(()=>{})),"OFFSCREEN_SAVE"===o?.type){const r="string"==typeof o.filename&&o.filename.trim()?o.filename:`google-meet-recording-${Date.now()}.webm`;if(o.blobUrl)return n("Saving OFFSCREEN_SAVE via blobUrl",r),void chrome.downloads.download({url:o.blobUrl,filename:r,saveAs:!0},()=>{chrome.runtime.lastError?n("downloads.download error:",chrome.runtime.lastError.message):chrome.runtime.sendMessage({type:"RECORDING_SAVED",filename:r}).catch(()=>{}),setTimeout(()=>{try{e?.postMessage({type:"REVOKE_BLOB_URL",blobUrl:o.blobUrl})}catch{}},1e4)})}}),o.onDisconnect.addListener(()=>{n("Offscreen disconnected"),e=null,r=!1,s(!1)}))}),chrome.runtime.onMessage.addListener((r,o,i)=>((async()=>{if("START_RECORDING"===r?.type){const e=r.tabId;if("number"!=typeof e)return void i({ok:!1,error:"Missing tabId"});n("Popup requested START_RECORDING for tabId",e);try{await a(),n("ensureOffscreen() completed")}catch(e){return void i({ok:!1,error:`Offscreen not ready: ${e?.message||e}`})}try{const r=await function(e){return new Promise((r,t)=>{try{chrome.tabCapture.getMediaStreamId({targetTabId:e},e=>{const o=chrome.runtime.lastError;return o?t(new Error(o.message)):e?void r(e):t(new Error("Empty streamId"))})}catch(e){t(e)}})}(e),o=await c({type:"OFFSCREEN_START",streamId:r});n("postToOffscreen(OFFSCREEN_START) response",o),o?.ok?(t=!0,s(!0),chrome.runtime.sendMessage({type:"RECORDING_STATE",recording:!0}).catch(()=>{}),i({ok:!0})):i({ok:!1,error:o?.error||"Failed to start"})}catch(e){n("OFFSCREEN_START failed",e),i({ok:!1,error:`OFFSCREEN_START failed: ${e?.message||e}`})}return}if("STOP_RECORDING"!==r?.type)"GET_RECORDING_STATUS"!==r?.type||i({recording:t});else try{await a(),e&&n("postToOffscreen(OFFSCREEN_STOP) response",await c({type:"OFFSCREEN_STOP"})),i({ok:!0})}catch(e){i({ok:!1,error:`STOP failed: ${e?.message||e}`})}})().catch(e=>{console.error("[background] top-level error",e),i({ok:!1,error:String(e)})}),!0)),chrome.runtime.onSuspend?.addListener(async()=>{try{e&&await c({type:"OFFSCREEN_STOP"})}catch{}s(!1)})})();