(()=>{"use strict";const e=document.getElementById("save"),t=document.getElementById("enable-mic"),r=document.getElementById("start-rec"),a=document.getElementById("stop-rec");function o(e){r&&a&&(r.disabled=e,a.disabled=!e)}function n(e){console.log("[popup]",e)}async function i(){await chrome.tabs.create({url:chrome.runtime.getURL("micsetup.html")})}async function s(){if(t&&"permissions"in navigator)try{const e=await navigator.permissions.query({name:"microphone"}),r=()=>{t.textContent="granted"===e.state?"Microphone Enabled ✓":"denied"===e.state?"Microphone Blocked":"Enable Microphone",t.disabled="granted"===e.state,t.title="granted"===e.state?"Microphone is already enabled for this extension":"Grant microphone permission so your voice is included in recordings"};r(),e.onchange=r}catch{}}(async()=>{try{const e=await chrome.runtime.sendMessage({type:"GET_RECORDING_STATUS"});o(!!e?.recording)}catch{o(!1)}s().catch(()=>{})})(),chrome.runtime.onMessage.addListener(e=>{"RECORDING_STATE"===e?.type&&o(!!e.recording),"RECORDING_SAVED"===e?.type&&(n(`Saved: ${e.filename||"recording.webm"}`),o(!1))}),t?.addEventListener("click",async()=>{try{if("permissions"in navigator){const e=await navigator.permissions.query({name:"microphone"});if("granted"===e.state)return alert("Microphone is already enabled for this extension."),void await s();if("denied"===e.state)return void await i()}try{(await navigator.mediaDevices.getUserMedia({audio:!0})).getTracks().forEach(e=>e.stop()),alert("Microphone enabled for the extension."),await s()}catch{await i()}}catch(e){console.error("[popup] mic enable flow error",e),alert("Could not open the microphone setup page. Please try again.")}}),e?.addEventListener("click",async()=>{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e?.id)return;const t=await chrome.tabs.sendMessage(e.id,{type:"GET_TRANSCRIPT"}).catch(e=>{n("No transcript on this page")}),r=t?.transcript;if(!r?.trim())return void n("Transcript is empty");const a=new Blob([r],{type:"text/plain"}),o=URL.createObjectURL(a),i=new URL(e.url??"https://meet.google.com").pathname.split("/").pop()||"google-meet";chrome.downloads.download({url:o,filename:`google-meet-transcript-${i}-${Date.now()}.txt`,saveAs:!0},()=>URL.revokeObjectURL(o))});let c=!1;r?.addEventListener("click",async()=>{if(r&&a&&!c){c=!0,r.disabled=!0;try{if("permissions"in navigator)try{if("granted"!==(await navigator.permissions.query({name:"microphone"})).state)try{(await navigator.mediaDevices.getUserMedia({audio:!0})).getTracks().forEach(e=>e.stop())}catch{}}catch{}const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e?.id)throw new Error("No active tab");await chrome.tabs.sendMessage(e.id,{type:"RESET_TRANSCRIPT"}).catch(()=>{});const t=await chrome.runtime.sendMessage({type:"START_RECORDING",tabId:e.id});if(!t)throw new Error("No response from background");if(!1===t.ok)throw new Error(t.error||"Failed to start");o(!0),n("Recording started")}catch(e){console.error("[popup] START_RECORDING error",e),o(!1),alert(`Failed to start recording:\n${e?.message||e}`)}finally{c=!1}}}),a?.addEventListener("click",async()=>{if(r&&a&&!c){c=!0,a.disabled=!0;try{const e=await chrome.runtime.sendMessage({type:"STOP_RECORDING"});if(!e)throw new Error("No response from background");if(!1===e.ok)throw new Error(e.error||"Failed to stop");n("Stopping… finalizing…")}catch(e){console.error("[popup] STOP_RECORDING error",e),alert(`Failed to stop recording:\n${e?.message||e}`),o(!1)}finally{c=!1}}})})();