(()=>{"use strict";window.addEventListener("error",e=>{console.error("[offscreen] window.onerror",e?.message,e?.error)}),window.addEventListener("unhandledrejection",e=>{console.error("[offscreen] unhandledrejection",e?.reason||e)}),console.log("[offscreen] script loaded");let e=null;function t(...e){console.log("[offscreen]",...e)}function r(){try{e?.disconnect()}catch{}const r=chrome.runtime.connect({name:"offscreen"});return r.onDisconnect.addListener(()=>{t("Port disconnected"),e=null}),r.postMessage({type:"OFFSCREEN_READY"}),t("READY signaled via Port"),e=r,r}function o(){return e??r()}function n(e,t){o().postMessage({__respFor:e?.__id,payload:t})}function a(e,t){try{chrome.storage?.session?.set?.({recording:e}).catch?.(()=>{})}catch{}o().postMessage({type:"RECORDING_STATE",recording:e,...t})}function c(e,r){try{const t=new(window.AudioContext||window.webkitAudioContext);t.resume().catch(()=>{});const o=t.createMediaStreamSource(new MediaStream([e])),n=t.createAnalyser();n.fftSize=256;const a=new Uint8Array(n.frequencyBinCount);o.connect(n);const c=setInterval(()=>{n.getByteTimeDomainData(a);let e=0;for(let t=0;t<a.length;t++){const r=(a[t]-128)/128;e+=r*r}const t=Math.sqrt(e/a.length);console.log("[offscreen]",`${r} input level (rms):`,t.toFixed(3))},1e3);e.addEventListener("ended",()=>{try{clearInterval(c)}catch{}})}catch(e){t("meter setup failed (non-fatal)",e)}}function i(e,t){const r={chromeMediaSource:t,chromeMediaSourceId:e};return{audio:{mandatory:r,optional:[{googDisableLocalEcho:!1}]},video:{mandatory:{...r,maxWidth:1920,maxHeight:1080,maxFrameRate:30}}}}let s=null,d=[],u=!1;async function l(e){if(u)return void t("Already recording; ignoring start");const r=await async function(e){try{return t(`Attempting getUserMedia with streamId ${e} source= tab`),await navigator.mediaDevices.getUserMedia(i(e,"tab"))}catch(e){t("[gUM] failed for chromeMediaSource=tab:",e?.name||e,e?.message||e)}return t(`Attempting getUserMedia with streamId ${e} source= desktop`),await navigator.mediaDevices.getUserMedia(i(e,"desktop"))}(e);await async function(e){const r=e.getAudioTracks(),n=e.getVideoTracks();if(t("getUserMedia() tracks:",{audioCount:r.length,videoCount:n.length,audioMuted:r[0]?.muted,audioEnabled:r[0]?.enabled}),r.forEach(e=>{try{e.enabled=!0}catch{}}),r.length){const e=r[0];console.log("[offscreen] audio track settings:",e?.getSettings?.()),console.log("[offscreen] audio track muted/enabled:",e?.muted,e?.enabled),e?.addEventListener("mute",()=>console.log("[offscreen] track MUTED")),e?.addEventListener("unmute",()=>console.log("[offscreen] track UNMUTED"))}else a(!1,{warning:"NO_TAB_AUDIO"});if(!n.length)throw new Error("No video track in captured stream");const i=e.getAudioTracks()[0];i&&c(i,"RAW");const l=function(e,r){const o=e.getAudioTracks()[0];if(!r||!o)return e;const n=new(window.AudioContext||window.webkitAudioContext);n.resume().catch(()=>{});const a=n.createMediaStreamDestination();try{n.createMediaStreamSource(new MediaStream([o])).connect(a)}catch(r){return t("tab source connect failed for mixing; using tab audio only",r),e}try{const e=r.getAudioTracks()[0];e&&n.createMediaStreamSource(new MediaStream([e])).connect(a)}catch(e){t("mic source connect failed; continuing with tab audio only",e)}return new MediaStream([...e.getVideoTracks(),...a.stream.getAudioTracks()])}(e,await async function(){try{const e=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}}),r=e.getAudioTracks()[0];return t("mic stream acquired:",!!r,"muted:",r?.muted,"enabled:",r?.enabled),e}catch(e){return t("mic getUserMedia failed (continuing without mic):",e),null}}()),g=l.getAudioTracks()[0];if(g&&c(g,"FINAL"),g||t("WARNING: final stream has NO audio track â€” recording will be silent"),t("final stream tracks -> video:",l.getVideoTracks().length,"audio:",l.getAudioTracks().length),i)try{const e=new(window.AudioContext||window.webkitAudioContext);await e.resume().catch(()=>{});const r=e.createMediaStreamSource(new MediaStream([i])),o=e.createAnalyser();o.fftSize=256;const n=new Uint8Array(o.frequencyBinCount);r.connect(o),await new Promise(e=>setTimeout(e,1e3)),o.getByteTimeDomainData(n);let a=0;for(let e=0;e<n.length;e++){const t=(n[e]-128)/128;a+=t*t}Math.sqrt(a/n.length)<.005&&t("no audio energy detected before start")}catch{}d=[];const m=MediaRecorder.isTypeSupported("video/webm;codecs=vp8,opus")?"video/webm;codecs=vp8,opus":"video/webm";s=new MediaRecorder(l,{mimeType:m,videoBitsPerSecond:3e6,audioBitsPerSecond:128e3});const f=new Promise((e,r)=>{const n=setTimeout(()=>r(new Error("MediaRecorder did not start (timeout)")),4e3);s.onstart=()=>{clearTimeout(n),u=!0,a(!0),t("MediaRecorder started"),e()},s.onerror=e=>{clearTimeout(n),t("MediaRecorder error",e);try{l.getTracks().forEach(e=>e.stop())}catch{}s=null,u=!1,a(!1),r(new Error(e?.name||"MediaRecorder error"))},s.ondataavailable=e=>{e.data&&e.data.size&&d.push(e.data)},s.onstop=async()=>{try{const e=new Blob(d,{type:m});t("Finalizing; chunks =",d.length,"blob.size =",e.size);let r="google-meet";try{const e=await chrome.tabs.query({active:!0,currentWindow:!0});r=function(e){try{return e&&new URL(e).pathname.split("/").pop()||"google-meet"}catch{return"google-meet"}}(e[0]?.url||null)}catch{}const n=`google-meet-recording-${r}-${Date.now()}.webm`,a=URL.createObjectURL(e);o().postMessage({type:"OFFSCREEN_SAVE",filename:n,blobUrl:a})}catch(e){t("Finalize/Save failed",e)}finally{try{l.getTracks().forEach(e=>e.stop())}catch{}s=null,d=[],u=!1,a(!1)}}});s.start(1e3),l.getVideoTracks()[0]?.addEventListener("ended",()=>{if(t("Video track ended"),s&&u)try{s.stop()}catch{}}),await f}(r)}o().onMessage.addListener(async e=>{try{if("OFFSCREEN_START"===e?.type){const t=e.streamId;if(!t)return n(e,{ok:!1,error:"Missing streamId"});try{return await l(t),n(e,{ok:!0})}catch(t){return n(e,{ok:!1,error:`${t?.name||"Error"}: ${t?.message||t}`})}}if("OFFSCREEN_START_TAB"===e?.type)return n(e,{ok:!1,error:"Use OFFSCREEN_START with streamId from background"});if("OFFSCREEN_STOP"===e?.type)try{return function(){if(!s||!u)throw console.warn("[offscreen] Stop called but not recording"),new Error("Not currently recording");try{s.stop()}catch(e){throw console.error("[offscreen] Stop error",e),e}}(),n(e,{ok:!0})}catch(t){return n(e,{ok:!1,error:String(t)})}if("OFFSCREEN_STATUS"===e?.type){let t=!1;try{const e=await(chrome.storage?.session?.get?.(["recording"]));t=!!e?.recording}catch{}return n(e,{recording:t})}if("DIAG_ECHO"===e?.type)return n(e,{ok:!0,pong:"offscreen-alive"});if("REVOKE_BLOB_URL"===e?.type&&"string"==typeof e.blobUrl){try{URL.revokeObjectURL(e.blobUrl)}catch{}return}}catch(t){console.error("[offscreen] error",t),n(e,{ok:!1,error:String(t)})}}),chrome.runtime.onMessage.addListener((e,t,o)=>{try{if("OFFSCREEN_PING"===e?.type)return o({ok:!0,via:"onMessage"}),!0;if("OFFSCREEN_CONNECT"===e?.type)return r(),o({ok:!0}),!0}catch(e){o({ok:!1,error:String(e)})}return!1})})();